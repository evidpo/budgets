# Безопасность приложения "Семейные финансы"

## Обзор

В данном документе описываются меры безопасности, применяемые в приложении "Семейные финансы", включая аутентификацию, авторизацию, защиту данных и политики Row Level Security (RLS).

## Архитектура безопасности

### Общая схема

Приложение использует многоуровневую архитектуру безопасности:
- Аутентификация на уровне приложения (Supabase Auth)
- Авторизация на уровне данных (RLS)
- Защита API (валидация, rate limiting)
- Защита на уровне приложения (валидация ввода, безопасные заголовки)

## Аутентификация

### Supabase Auth

Приложение использует встроенную систему аутентификации Supabase, которая обеспечивает:

#### Типы аутентификации
- Email/password аутентификация
- OAuth провайдеры (Google, GitHub, GitLab и др.)
- Magic link аутентификация
- Телефонная аутентификация (опционально)

#### Безопасные практики
- Пароли хранятся в зашифрованном виде с использованием bcrypt
- Все сессии защищены JWT токенами
- Поддержка мультифакторной аутентификации (MFA)
- Автоматический logout при неактивности
- Защита от brute force атак

#### JWT токены
- Access токены: срок действия 1 час
- Refresh токены: срок действия 30 дней
- Токены содержат информацию о пользователе и правах доступа
- Подпись токенов с использованием безопасного алгоритма

## Авторизация и управление доступом

### Модель домохозяйства (Household)

Основной принцип авторизации в приложении - разделение данных по домохозяйствам (households):

- Каждый пользователь может принадлежать к одному или нескольким домохозяйствам
- Данные принадлежат домохозяйству, а не отдельному пользователю
- Пользователи имеют доступ только к данным своего домохозяйства

### Роли пользователей

В каждом домохозяйстве поддерживаются следующие роли:

#### Owner (владелец)
- Полный доступ ко всем данным домохозяйства
- Право приглашать/удалять участников
- Право изменять настройки домохозяйства
- Максимальные права на все функции

#### Editor (редактор)
- Просмотр всех данных домохозяйства
- Создание и редактирование транзакций, счетов, бюджетов и т.д.
- Просмотр отчетов
- Ограниченный доступ к настройкам

#### Viewer (наблюдатель)
- Только просмотр данных домохозяйства
- Просмотр отчетов
- Нет прав на создание или изменение данных
- Нет доступа к настройкам

## Row Level Security (RLS) политики

### Общие принципы

Все таблицы в базе данных используют RLS для обеспечения безопасности на уровне строк:
- Пользователи могут видеть только те строки, которые принадлежат их домохозяйству
- RLS политики применяются на уровне PostgreSQL
- Все операции проверяются на соответствие политикам безопасности

### Политики для основных таблиц

#### Таблица accounts

```sql
-- Политика для чтения
CREATE POLICY "Users can view their household accounts" ON accounts
FOR SELECT USING (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
  )
);

-- Политика для вставки
CREATE POLICY "Users can insert into their household accounts" ON accounts
FOR INSERT WITH CHECK (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
    AND (m.role = 'owner' OR m.role = 'editor')
  )
);

-- Политика для обновления
CREATE POLICY "Users can update their household accounts" ON accounts
FOR UPDATE USING (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
    AND (m.role = 'owner' OR m.role = 'editor')
  )
);

-- Политика для удаления
CREATE POLICY "Owners can delete their household accounts" ON accounts
FOR DELETE USING (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
    AND m.role = 'owner'
  )
);
```

#### Таблица transactions

```sql
-- Политика для чтения
CREATE POLICY "Users can view their household transactions" ON transactions
FOR SELECT USING (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
  )
);

-- Политика для вставки
CREATE POLICY "Users can insert into their household transactions" ON transactions
FOR INSERT WITH CHECK (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
    AND (m.role = 'owner' OR m.role = 'editor')
  )
);

-- Политика для обновления
CREATE POLICY "Users can update their household transactions" ON transactions
FOR UPDATE USING (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
    AND (m.role = 'owner' OR m.role = 'editor')
  )
);

-- Политика для удаления
CREATE POLICY "Users can delete their household transactions" ON transactions
FOR DELETE USING (
  household_id IN (
    SELECT id FROM households h
    JOIN members m ON h.id = m.household_id
    WHERE m.user_id = auth.uid()
    AND m.role = 'owner'
  )
);
```

Аналогичные политики применяются ко всем остальным таблицам (budgets, categories, debts, rules и т.д.).

### Проверка принадлежности к домохозяйству

Для всех таблиц с полем `household_id` используется стандартная проверка:

```sql
-- Функция для проверки принадлежности к домохозяйству
CREATE OR REPLACE FUNCTION is_household_member(household_id UUID)
RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
BEGIN
 RETURN EXISTS (
    SELECT 1 FROM members m
    WHERE m.household_id = is_household_member.household_id
    AND m.user_id = auth.uid()
  );
END;
$$;

-- Использование в политике
CREATE POLICY "Check household membership" ON accounts
FOR ALL USING (is_household_member(household_id));
```

## Защита API

### Валидация входных данных

#### Frontend валидация
- Проверка типов данных
- Проверка формата (email, даты, суммы и т.д.)
- Проверка диапазонов значений
- Sanitization ввода пользователя

#### Backend валидация
- Повторная проверка всех входных данных
- Проверка соответствия схеме
- Проверка бизнес-логики
- Защита от SQL-инъекций (через Supabase RPC)

### Rate Limiting

- Ограничение количества запросов в минуту (например, 100 запросов/мин)
- Защита от DDoS атак
- Механизмы для предотвращения злоупотреблений

### CORS политики

- Ограничение источников для API запросов
- Защита от CSRF атак
- Правильная настройка CORS заголовков

## Защита данных

### Шифрование

#### В передаче
- HTTPS/TLS 1.3 для всех соединений
- Защита всех API запросов
- Шифрование данных в реальном времени

#### В покое
- Шифрование данных в базе данных
- Шифрование резервных копий
- Защита ключей шифрования

### Хранение чувствительных данных

- Пароли: хранятся в зашифрованном виде (bcrypt)
- JWT токены: хранятся как хэши
- Персональные данные: минимальное хранение
- Финансовые данные: агрегированные отчеты, не raw данные

### Приватность

- Минимизация сбора персональных данных
- Возможность экспорта и удаления данных пользователя
- Соответствие GDPR требованиям
- Четкая политика конфиденциальности

## Безопасность на уровне приложения

### Защита от распространенных уязвимостей

#### XSS (Cross-Site Scripting)
- Sanitization всех пользовательских данных
- Использование безопасных методов рендеринга
- Content Security Policy заголовки

#### CSRF (Cross-Site Request Forgery)
- CSRF токены для форм
- Проверка origin заголовков
- SameSite cookie атрибуты

#### SQL-инъекции
- Использование параметризованных запросов
- Валидация всех входных данных
- Ограниченные права доступа к БД

### Аудит безопасности

#### Логирование безопасности
- Логирование всех аутентификационных попыток
- Логирование подозрительных действий
- Логирование изменений в настройках безопасности

#### Мониторинг
- Мониторинг необычной активности
- Оповещения о потенциальных угрозах
- Регулярные проверки безопасности

## Безопасность домохозяйств и приглашений

### Система приглашений

#### Создание приглашений
- Приглашения создаются только владельцами
- Временные токены с ограниченным сроком действия
- Проверка email приглашаемого пользователя

#### Принятие приглашений
- Проверка токена приглашения
- Подтверждение email
- Назначение начальной роли

### Управление доступом

#### Добавление/удаление участников
- Только владелец может добавлять/удалять участников
- Возможность изменения ролей
- Уведомления об изменениях

#### Архивация домохозяйств
- Возможность архивации домохозяйства владельцем
- Ограничение доступа к архивированным данным
- Возможность восстановления

## Обновления безопасности

### Регулярные проверки

- Аудит зависимостей (npm audit, dependabot)
- Проверка уязвимостей в Supabase
- Обновление безопасности на всех уровнях

### Реагирование на инциденты

- Процедуры реагирования на утечки данных
- Резервные копии и восстановление
- Уведомления пользователей при инцидентах

## Рекомендации по безопасности для пользователей

### Лучшие практики

- Использование сложных паролей
- Включение двухфакторной аутентификации
- Регулярная смена паролей
- Проверка подозрительных активностей

### Образование пользователей

- Рекомендации по безопасности в интерфейсе
- Обучение по защите финансовых данных
- Рекомендации по безопасному использованию приложения

## Заключение

Безопасность в приложении "Семейные финансы" обеспечивается комплексным подходом, включающим:
- Аутентификацию и авторизацию на всех уровнях
- Защиту данных с использованием RLS политик
- Валидацию и защиту API
- Постоянный мониторинг и аудит безопасности

Все компоненты системы регулярно проверяются и обновляются для обеспечения максимальной защиты финансовых данных пользователей.