# Документация по миграции структуры проекта "Семейные финансы"

## 1. Цель миграции структуры

Миграция структуры проекта "Семейные финансы" была выполнена для трансформации первоначальной архитектуры в полнофункциональную систему управления семейными финансами с поддержкой совместной работы в "домохозяйствах" (households). Основные цели миграции:

- Внедрение поддержки совместной работы в "семье" с различными ролями участников
- Создание иерархической структуры категорий с поддержкой иконок и цветов
- Реализация сложной логики бюджетирования с поддержкой фильтрации по счетам и категориям
- Внедрение системы правил автокатегоризации транзакций
- Обеспечение безопасности данных через Row Level Security (RLS)
- Повышение производительности системы через оптимизацию структуры базы данных и индексов

## 2. Описание исходной структуры проекта

Исходная структура проекта была базовой и включала в себя следующие основные компоненты:

### 2.1. База данных (PostgreSQL через Supabase)

**Таблица `accounts`** (миграция `0001_create_accounts_table.sql`):
- `id`: UUID, первичный ключ
- `user_id`: UUID, внешний ключ на пользователя
- `name`: VARCHAR(25), название счета
- `type`: VARCHAR(50), тип счета (cash, checking, savings, credit_card, investment)
- `balance`: DECIMAL(15, 2), текущий баланс
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления

**Таблица `transactions`** (миграция `03_create_transactions_table.sql`):
- `id`: UUID, первичный ключ
- `user_id`: UUID, внешний ключ на пользователя
- `account_id`: UUID, внешний ключ на счет
- `category_id`: UUID, внешний ключ на категорию
- `description`: VARCHAR(500), описание транзакции
- `amount`: DECIMAL(15, 2), сумма
- `type`: VARCHAR(20), тип (income или expense)
- `date`: TIMESTAMP, дата транзакции
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления

**Таблица `budgets`** (миграция `04_create_budgets_table.sql`):
- `id`: UUID, первичный ключ
- `user_id`: UUID, внешний ключ на пользователя
- `category_id`: UUID, внешний ключ на категорию
- `amount`: DECIMAL(15, 2), сумма бюджета
- `period`: VARCHAR(20), период (daily, weekly, monthly, yearly)
- `start_date`, `end_date`: DATE, даты начала и окончания
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления

**Таблица `debts`** (миграция `05_create_debts_table.sql`):
- `id`: UUID, первичный ключ
- `user_id`: UUID, внешний ключ на пользователя
- `name`: VARCHAR(255), название долга
- `amount`: DECIMAL(15, 2), сумма
- `interest_rate`: DECIMAL(5, 2), процентная ставка
- `minimum_payment`: DECIMAL(15, 2), минимальный платеж
- `start_date`, `end_date`: DATE, даты начала и окончания
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления

### 2.2. Frontend структура

Исходная frontend структура была минимальной и включала базовые компоненты для работы с каждым типом сущности.

## 3. Описание целевой структуры проекта

Целевая структура проекта включает в себя полноценную архитектуру для управления семейными финансами с поддержкой совместной работы:

### 3.1. База данных (PostgreSQL через Supabase)

**Таблица `households`** (миграция `0006_create_users_households_members_tables.sql`):
- `id`: UUID, первичный ключ
- `name`: VARCHAR(255), название домохозяйства
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления
- `version`: INTEGER, версия для отслеживания конфликтов

**Таблица `members`** (миграция `006_create_users_households_members_tables.sql`):
- `id`: UUID, первичный ключ
- `household_id`: UUID, внешний ключ на домохозяйство
- `user_id`: UUID, внешний ключ на пользователя
- `role`: VARCHAR(20), роль (owner, editor, viewer)
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления
- `version`: INTEGER, версия для отслеживания конфликтов
- Уникальность: `(household_id, user_id)`

**Таблица `accounts`** (миграция `0013_update_accounts_table_with_household.sql`):
- `id`: UUID, первичный ключ
- `household_id`: UUID, внешний ключ на домохозяйство
- `name`: VARCHAR(255), название счета
- `type`: VARCHAR(50), тип счета (cash, card, savings, credit, other)
- `currency`: VARCHAR(3), валюта (по умолчанию 'EUR')
- `opening_balance`: DECIMAL(15, 2), начальный баланс
- `is_archived`: BOOLEAN, флаг архивации
- `note`: TEXT, заметка
- `sort_order`: INTEGER, порядок сортировки
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления
- `version`: INTEGER, версия для отслеживания конфликтов

**Таблица `categories`** (миграция `007_create_categories_table_with_hierarchy.sql`):
- `id`: UUID, первичный ключ
- `household_id`: UUID, внешний ключ на домохозяйство
- `parent_id`: UUID, внешний ключ на родительскую категорию (для иерархии)
- `name`: VARCHAR(255), название категории
- `path`: VARCHAR(500), путь в иерархии (например, 'Root:Child:Sub')
- `icon`: VARCHAR(50), иконка
- `color`: VARCHAR(7), цвет (#RRGGBB)
- `updated_at`, `version`: TIMESTAMP и INTEGER, даты и версия

**Таблица `transactions`** (миграция `0008_create_transactions_table_with_household.sql`):
- `id`: UUID, первичный ключ
- `household_id`: UUID, внешний ключ на домохозяйство
- `date`: DATE, дата транзакции
- `account_id`: UUID, внешний ключ на счет
- `amount`: DECIMAL(15, 2), сумма (±)
- `category_id`: UUID, внешний ключ на категорию (опционально)
- `payee`: VARCHAR(25), плательщик
- `note`: TEXT, заметка
- `debt_id`: UUID, внешний ключ на долг (опционально)
- `transfer_id`: UUID, внешний ключ на перевод (опционально)
- `member_id`: UUID, внешний ключ на участника
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления
- `version`: INTEGER, версия для отслеживания конфликтов

**Таблица `transfers`** (миграция `009_create_transfers_table.sql`):
- `id`: UUID, первичный ключ
- `from_tx_id`: UUID, внешний ключ на исходящую транзакцию (уникальный)
- `to_tx_id`: UUID, внешний ключ на входящую транзакцию (уникальный)

**Таблица `budgets`** (миграция `0010_create_budgets_table_with_household.sql`):
- `id`: UUID, первичный ключ
- `household_id`: UUID, внешний ключ на домохозяйство
- `name`: VARCHAR(255), название бюджета
- `period_type`: VARCHAR(20), тип периода (week, month, quarter, year, custom)
- `start_date`: DATE, дата начала
- `end_date`: DATE, дата окончания (опционально)
- `amount`: DECIMAL(15, 2), сумма бюджета
- `direction`: VARCHAR(10), направление (expense, income)
- `rollover`: BOOLEAN, флаг переноса остатка
- `include_subtree`: BOOLEAN, флаг включения поддерева категорий
- `sort_order`: INTEGER, порядок сортировки
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления
- `version`: INTEGER, версия для отслеживания конфликтов

**Таблица `budget_categories`** (миграция `011_create_budget_categories_budget_accounts_tables.sql`):
- `budget_id`: UUID, внешний ключ на бюджет
- `category_id`: UUID, внешний ключ на категорию
- `created_at`: TIMESTAMP, дата создания
- Составной первичный ключ: `(budget_id, category_id)`

**Таблица `budget_accounts`** (миграция `011_create_budget_categories_budget_accounts_tables.sql`):
- `budget_id`: UUID, внешний ключ на бюджет
- `account_id`: UUID, внешний ключ на счет
- `created_at`: TIMESTAMP, дата создания
- Составной первичный ключ: `(budget_id, account_id)`

**Таблица `rules`** (миграция `0012_create_rules_table.sql`):
- `id`: UUID, первичный ключ
- `household_id`: UUID, внешний ключ на домохозяйство
- `type`: VARCHAR(20), тип правила (payee, regex, amount_pattern)
- `priority`: INTEGER, приоритет
- `category_id`: UUID, внешний ключ на категорию
- `pattern`: TEXT, паттерн для поиска
- `is_active`: BOOLEAN, флаг активности
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления
- `version`: INTEGER, версия для отслеживания конфликтов

**Таблица `debts`** (миграция `0014_update_debts_table_with_household.sql`):
- `id`: UUID, первичный ключ
- `household_id`: UUID, внешний ключ на домохозяйство
- `name`: VARCHAR(255), название долга
- `counterparty`: VARCHAR(255), контрагент
- `opening_balance`: DECIMAL(15, 2), начальный баланс
- `note`: TEXT, заметка
- `created_at`, `updated_at`: TIMESTAMP, даты создания и обновления
- `version`: INTEGER, версия для отслеживания конфликтов

### 3.2. Frontend структура

Целевая frontend структура включает:

- Next.js приложение с TypeScript
- Страницы для всех сущностей: `/accounts`, `/transactions`, `/budgets`, `/categories`, `/debts`, `/rules`, `/reports`, `/import`
- Компоненты для работы с каждым типом сущности
- Кастомные React хуки для работы с данными
- Система реалтайм-обновлений через Supabase Realtime
- Валидация и обработка ошибок

## 4. Пошаговый план миграции

Миграция структуры проекта была выполнена по следующему плану:

### 4.1. Этап 1: Создание базовой структуры (миграции 0001-05)

1. Создание таблиц `accounts`, `transactions`, `budgets`, `debts` с базовыми полями
2. Добавление индексов для ускорения поиска
3. Создание триггеров для автоматического обновления времени

### 4.2. Этап 2: Внедрение поддержки домохозяйств (миграция 0006)

1. Создание таблиц `households` и `members` для поддержки совместной работы
2. Добавление внешних ключей и индексов
3. Внедрение системы версионирования данных

### 4.3. Этап 3: Обновление структуры категорий (миграция 007)

1. Добавление поля `household_id` к таблице `categories`
2. Внедрение поддержки иерархии категорий с полями `parent_id` и `path`
3. Добавление полей `icon` и `color` для визуализации
4. Создание индексов для производительности

### 4.4. Этап 4: Обновление структуры транзакций (миграция 0008)

1. Добавление поля `household_id` к таблице `transactions`
2. Внедрение новых полей: `payee`, `debt_id`, `transfer_id`, `member_id`
3. Обновление внешних ключей для новых связей
4. Добавление индексов для производительности

### 4.5. Этап 5: Создание структуры переводов (миграция 0009)

1. Создание таблицы `transfers` для хранения связей между транзакциями-переводами
2. Добавление внешних ключей и индексов

### 4.6. Этап 6: Обновление структуры бюджетов (миграция 0010)

1. Добавление поля `household_id` к таблице `budgets`
2. Внедрение новых полей: `direction`, `rollover`, `include_subtree`, `sort_order`
3. Обновление внешних ключей
4. Добавление индексов для производительности

### 4.7. Этап 7: Создание связующих таблиц для бюджетов (миграция 011)

1. Создание таблиц `budget_categories` и `budget_accounts`
2. Внедрение составных первичных ключей
3. Добавление индексов для производительности

### 4.8. Этап 8: Создание системы правил (миграция 0012)

1. Создание таблицы `rules` для автокатегоризации транзакций
2. Добавление полей для различных типов правил
3. Создание индексов для производительности

### 4.9. Этап 9: Обновление структуры счетов (миграция 0013)

1. Добавление поля `household_id` к таблице `accounts`
2. Внедрение новых полей: `currency`, `opening_balance`, `is_archived`, `note`, `sort_order`
3. Обновление внешних ключей
4. Добавление индексов для производительности

### 4.10. Этап 10: Обновление структуры долгов (миграция 0014)

1. Добавление поля `household_id` к таблице `debts`
2. Внедрение новых полей: `counterparty`, `opening_balance`, `note`
3. Обновление внешних ключей
4. Добавление индексов для производительности

### 4.11. Этап 11: Внедрение безопасности (миграция 015)

1. Включение Row Level Security для всех таблиц
2. Создание политик доступа для каждой таблицы
3. Обеспечение изоляции данных между домохозяйствами

### 4.12. Этап 12: Оптимизация производительности (миграция 0016)

1. Создание дополнительных индексов для производительности
2. Использование `CONCURRENTLY` для избежания блокировок
3. Оптимизация индексов для часто используемых запросов

## 5. Потенциальные риски и пути их минимизации

### 5.1. Риски, связанные с миграцией данных

**Риск**: Потеря данных или их повреждение в процессе миграции
**Минимизация**: 
- Создание резервных копий перед миграцией
- Тестирование миграций на копии данных
- Использование транзакций для атомарности изменений
- Постепенное выполнение миграций с промежуточной проверкой

### 5.2. Риски, связанные с производительностью

**Риск**: Деградация производительности после миграции
**Минимизация**:
- Планирование создания индексов с использованием `CONCURRENTLY`
- Тестирование производительности до и после миграции
- Оптимизация запросов и структуры базы данных

### 5.3. Риски, связанные с безопасностью

**Риск**: Нарушение изоляции данных между домохозяйствами
**Минимизация**:
- Тщательное тестирование политик RLS
- Ревью политик безопасности перед применением
- Проверка доступа к данным из разных учетных записей

### 5.4. Риски, связанные совместимостью

**Риск**: Несовместимость с существующим кодом
**Минимизация**:
- Постепенное обновление кода в соответствии с новой структурой
- Поддержка обратной совместимости на время перехода
- Тестирование интеграции с новой структурой

## 6. Проверочные точки и тестирование

### 6.1. Проверка целостности данных

- Проверка соответствия внешних ключей
- Проверка уникальности данных
- Проверка ограничений NOT NULL
- Проверка корректности значений по умолчанию

### 6.2. Проверка безопасности

- Проверка политик RLS для каждой таблицы
- Проверка изоляции данных между домохозяйствами
- Проверка корректности ролей участников

### 6.3. Проверка функциональности

- Тестирование CRUD операций для всех сущностей
- Проверка работы иерархии категорий
- Проверка работы бюджетирования
- Проверка работы правил автокатегоризации
- Проверка работы системы переводов

### 6.4. Проверка производительности

- Тестирование скорости выполнения основных запросов
- Проверка эффективности индексов
- Тестирование с большими объемами данных
- Проверка работы реалтайм-обновлений

## 7. Рекомендации пост-миграционной проверке

### 7.1. Проверка данных

- Проверка корректности переноса данных из старой структуры в новую
- Проверка целостности иерархии категорий
- Проверка корректности связей между транзакциями и бюджетами
- Проверка корректности начальных балансов

### 7.2. Проверка функциональности

- Тестирование всех основных сценариев использования
- Проверка работы совместной работы в домохозяйствах
- Проверка работы правил автокатегоризации
- Проверка работы отчетов и аналитики

### 7.3. Проверка производительности

- Мониторинг времени отклика приложения
- Проверка скорости выполнения запросов
- Анализ использования индексов
- Проверка нагрузки на базу данных

### 7.4. Проверка безопасности

- Проверка корректности политик RLS
- Проверка изоляции данных между пользователями
- Проверка работы системы ролей
- Аудит доступа к чувствительным данным

### 7.5. Рекомендации по дальнейшему сопровождению

- Регулярный аудит безопасности
- Мониторинг производительности
- Периодическое обновление статистики для оптимизатора запросов
- Поддержка актуальности документации