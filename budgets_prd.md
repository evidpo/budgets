# PRD — Семейные финансы (MVP, Web‑first)
Версия: 1.0 · Автор: ChatGPT · Дата: 2025‑09‑28

---

## 0) Кратко
Веб‑приложение для семейного учёта: **Счета**, **Транзакции**, **Бюджеты**, **Категории**, **Долги**, **Правила**, **Отчёты**, **Импорт CSV**.

- Транзакции — **только доход/расход** (тип определяется **знаком** `amount`).
- **Перевод** = две транзакции (−X на счёте A, +X на счёте B) с общим `transfer_id`.
- **Бюджеты** — мультипериоды (нед/мес/кварт/год/custom) + перенос остатка; **исключают переводы**.
- Реалтайм — Supabase Realtime. Auth — Supabase Auth. БД — Postgres.

[Предположение] «Конверты» (sinking funds) **не входят** в MVP, но архитектура позволяет добавить их позднее без переделок.

---

## 1) Цели и критерии успеха
**Цели:**
1. Быстрое добавление транзакций (≤10 сек на запись).
2. Совместная работа в «семье» (household) с ролями.
3. Простые и понятные **Бюджеты** с переносом.
4. Базовые **Отчёты** (общий баланс; по бюджетам; по счетам; доходы/расходы по категориям).
5. Импорт из CSV (Alzex) с мастер‑склейкой переводов.

**Метрики:**
- Доля автокатегоризованных транзакций ≥ 60% в первый месяц.
- Время до первой записи ≤ 2 минуты с нуля.
- 0 критических расхождений в балансах после импорта.

---

## 2) Навигация / разделы (названия зафиксированы)
- **Счета** (`/accounts`) — список счетов (drag & drop), название + текущий баланс.
- **Транзакции** (`/transactions`) — лента с фильтрами; создание расход/доход/перевод.
- **Бюджеты** (`/budgets`) — список и карточка бюджета.
- **Категории** (`/categories`) — дерево категорий (иконка/цвет).
- **Долги** (`/debts`) — список долгов и остатки.
- **Правила** (`/rules`) — автокатегоризация.
- **Отчёты** (`/reports`) — базовые отчёты.
- **Импорт** (`/import`) — мастер CSV (Alzex).

---

## 3) Ключевые принципы модели
1) **Счёт ≠ Бюджет.** Счёт — реальные деньги; бюджет — расчётный объект (не хранит деньги).
2) **Тип транзакции — по знаку суммы.** `amount > 0` = доход, `< 0` = расход.
3) **Переводы** храним как пару обычных транзакций, связываем `transfer_id`; **не учитываем** в доходах/расходах и бюджетах.
4) **Бюджет** может фильтровать транзакции **по счетам**, **по категориям** (с поддеревом) или по **их пересечению**. Перенос остатка опционален.

---

## 4) Функциональные требования по разделам

### 4.1) Счета
**UI:** компактный список: «хваталка» · **Название** · **Баланс** (выравнивание справа).
- Перетаскивание меняет `sort_order` (батч‑PATCH).
- Архивные скрыты (переключатель «Показать архивные»). [Предположение]
- Клик по счёту открывает отфильтрованные транзакции этого счёта.

**Баланс:** `opening_balance + Σ amount` по транзакциям счёта (переводы учитываются, это реальные движения).

**API:**
- `GET /accounts?include_balance=1` → `[ { id, name, sort_order, is_archived, balance } ]`
- `PATCH /accounts/reorder` → `[{ id, sort_order }]`
- `PATCH /accounts/:id` → rename/archive

**Приёмка:** перевод A→B изменяет балансы A и B на −X/+X; порядок сохраняется после перезагрузки.

---

### 4.2) Транзакции
**Создание:** «+ Транзакция» → **Расход / Доход / Перевод**.
- Расход/Доход: дата, счёт, сумма, категория, payee, заметка, [опц] `debt`, [опц] `member`.
- Перевод: счёт A, счёт B, сумма, дата, заметка → создаются 2 записи + `transfer_id` (атомарно).

**Лента/фильтры:** даты, счёт, категория‑поддерево, участник, долг, «исключить переводы».

**Автокатегоризация (MVP):**
- Типы: `payee`, `regex(comment)`, `amount_pattern`.
- Конфликты: приоритет (payee > regex > amount). Применение показываем в UI («правило X» + отмена).

**API:**
- `GET /transactions` (фильтры: даты, счета[], категория‑поддерево, member_id, debt_id, `exclude_transfers=true`)
- `POST /transactions` (доход/расход; [Предположение] поддержка `idempotency_key`)
- `POST /transfers` (атомарное создание пары транзакций)

---

### 4.3) Бюджеты
**Модель:** `name, period_type (week|month|quarter|year|custom), start_date, end_date?, amount, direction (expense|income), rollover, include_subtree, filters: category_ids[], account_ids[]`.

**Расчёт:** (переводы исключены)
- **Expense:** `spent = Σ |amount| (<0)`; `available = (limit + carry_prev) − spent`; при `rollover=ON` переносим `available`.
- **Income:** `income = Σ amount (>0)`; `available = (limit + carry_prev) − income`; перенос аналогично.

**UI карточки:** Период, Лимит, Факт на «сейчас», Перенос, **Доступно сейчас**, детализация транзакций бюджета.

**Мастер создания:** Период → Лимит/Перенос → Фильтры (категории/счета, «включать поддерево»). Если заданы и категории, и счета — **пересечение**. [Предположение]

**API:**
- `GET/POST/PATCH /budgets`
- `GET /budgets/:id/compute?as_of=YYYY-MM-DD`

---

### 4.4) Категории
- Дерево: `parent_id`, `path` вида `Root:Child:Sub`.
- UX‑поля: `icon`, `color` (HEX, валидируется).
- Drag’n’drop, поиск.

---

### 4.5) Долги
- `Debt`: `name, counterparty, opening_balance, note`.
- Остаток = `opening_balance + Σ amount` по транзакциям с `debt_id`.
- [Предположение] Получили займ — доход (+), погашение — расход (−).

---

### 4.6) Импорт CSV (Alzex)
1) Загрузка → автоопределение формата.
2) Маппинг: дата, сумма, счёт, категория (`:` → дерево), payee, комментарий, долг.
3) Склейка переводов: эвристика (±сумма, встречные знаки, разные счета, окно ±3 дня) → пользователь подтверждает пары → проставляется `transfer_id`.
4) Предпросмотр → запись → «откатить импорт».

---

## 5) Отчёты (MVP)

### 5.1) Общий баланс
**Блок А — Баланс на сейчас:**
- Таблица: Счёт · Баланс; строка «Итого». (Переводы **включены** — это фактический остаток.)

**Блок Б — Движение за период:**
- Период `from/to`; чекбокс **«Исключить переводы»** (по умолчанию включён).
- Таблица: Счёт · Поступления · Списания · Нетто · Баланс на начало · Баланс на конец (= начало + нетто).

### 5.2) По бюджетам (текущий период)
- Бюджет · Период · Лимит · Факт · Перенос · **Доступно сейчас**.

### 5.3) По счетам (за период)
- Счёт · Поступления · Списания · Нетто; чекбокс «исключить переводы» (вкл по умолчанию).

### 5.4) Доходы по категориям (за период)
- Категория · Путь · Сумма; тумблер «группировать по корню».

### 5.5) Расходы по категориям (за период)
- Категория · Путь · Сумма; тумблер «группировать по корню».

Во всех отчётах — **Экспорт CSV**.

---

## 6) Реалтайм и синхронизация
- **Supabase Realtime**: подписки на `transactions`, `accounts`, `budgets`, `debts`, `categories` c фильтром по `household_id` (RLS).
- **Оптимистичные апдейты** на фронте (React Query) + пересчёт списка счетов/балансов локально.
- Поля `updated_at`, `version` в ключевых таблицах (для конфликтов/синхронизации).

[Предположение] Альтернатива на будущее — собственный WS‑хаб поверх Postgres `LISTEN/NOTIFY`.

---

## 7) Дизайн‑гайд (просто, легко, интуитивно)
- **IA:** три главных списка — Счета, Транзакции, Бюджеты.
- **Типографика:** base 16, заголовки 20/24/32; сетка отступов 8px.
- **Токены темы (CSS vars):** `--bg, --text, --muted, --primary, --success, --warning, --danger`. Тёмная тема.
- **Компоненты:** плотные строки; у категорий — иконка + цвет‑точка; у денег — выравнивание вправо, моноширинный шрифт для сумм [Предположение].
- **Формы:** до 6–7 полей, подсказки, автокатегоризация с заметной плашкой «Применено правило».
- **Доступность:** контраст ≥ 4.5:1, фокус‑стили, таб‑навигация.
- **Анимации:** микро (hover/press), без «тяжёлых» переходов.

---

## 8) Модель данных (сводка)
**USERS**: `id, email, created_at, [password_hash?, password_algo?, email_verified_at?, external_provider?, external_subject?]`

**HOUSEHOLDS**: `id, name, created_at`

**MEMBERS**: `id, household_id(FK), user_id(FK), role('owner'|'editor'|'viewer'), created_at, UNIQUE(household_id,user_id)`

**ACCOUNTS**: `id, household_id(FK), name, type('cash'|'card'|'savings'|'credit'|'other'), currency='EUR', opening_balance, is_archived, note, sort_order, created_at, updated_at, version`

**CATEGORIES**: `id, household_id(FK), parent_id(FK), name, path, icon, color(#RRGGBB), updated_at, version`

**DEBTS**: `id, household_id(FK), name, counterparty, opening_balance, note, updated_at, version`

**TRANSACTIONS**: `id, household_id(FK), date, account_id(FK), amount(±), category_id(FK?), payee, note, debt_id(FK?), transfer_id(FK?), member_id(FK?), created_at, updated_at, version`

**TRANSFERS**: `id, from_tx_id(FK UNIQUE), to_tx_id(FK UNIQUE)`

**BUDGETS**: `id, household_id(FK), name, period_type, start_date, end_date?, amount, direction, rollover, include_subtree, sort_order, updated_at, version`

**BUDGET_CATEGORIES**: `budget_id(FK), category_id(FK)` (PK составной)

**BUDGET_ACCOUNTS**: `budget_id(FK), account_id(FK)` (PK составной)

**RULES**: `id, household_id(FK), type('payee'|'regex'|'amount_pattern'), priority, category_id(FK), pattern, is_active, created_at`

Индексы: `transactions(household_id,date DESC)`, `account_id`, `category_id`, `debt_id`, `transfer_id`, `member_id`; `accounts(household_id, sort_order NULLS LAST, name)`; `budgets(household_id, sort_order NULLS LAST, name)`; `categories(household_id, path)`; `rules(household_id,type,is_active)`.

[Предположение] «Конверты» исключены из MVP; тип счёта `envelope`/таблица метаданных можно добавить позже без изменения контрактов.

---

## 9) API поверхность (контуры)
- **Auth/Members/Invites** — Supabase (встроенные эндпоинты) + `POST /invites`, `POST /invites/accept`.
- **Accounts**: `GET /accounts?include_balance=1`, `PATCH /accounts/reorder`, `PATCH /accounts/:id`.
- **Transactions**: `GET /transactions`, `POST /transactions`, `POST /transfers`.
- **Budgets**: `GET/POST/PATCH /budgets`, `GET /budgets/:id/compute?as_of=`.
- **Rules**: `GET/POST/PATCH /rules`, `POST /rules/apply`.
- **Debts**: `GET/POST/PATCH /debts`.
- **Reports**:
  - `GET /reports/overall-balance?include_archived=false` — Баланс на сейчас (реальный).
  - `GET /reports/overall-movement?from=&to=&exclude_transfers=true` — Движение за период.
  - `GET /reports/by-budgets?as_of=` — По бюджетам.
  - `GET /reports/by-accounts?from=&to=&exclude_transfers=true` — По счетам.
  - `GET /reports/income-by-category?from=&to=&group_root=false` — Доходы по категориям.
  - `GET /reports/expense-by-category?from=&to=&group_root=false` — Расходы по категориям.

---

## 10) Безопасность
- RLS: доступ только к строкам с `household_id` участника.
- JWT Supabase Auth.
- Валидация на сервере; аудиты: `updated_at`, `version`.
- Для инвайтов/сброса паролей — хранить **только хеши токенов**. [Предположение]

---

## 11) Нефункциональные требования
- **Производительность:** 100k+ транзакций без деградации UX (индексы, курсорная пагинация, виртуализация списков).
- **Надёжность:** идемпотентность `POST /transactions`; откат импорта.
- **Доступность:** контраст ≥ 4.5:1; фокус‑стили; таб‑навигация.
- **PWA:** офлайн‑чтение (кэш); запись — при онлайн.

---

## 12) Приёмочные сценарии (выборка)
**Транзакции/Переводы**
- Перевод A→B на X создаёт 2 строки с общим `transfer_id`; доход/расход отчёты и бюджеты их не учитывают.

**Счета**
- Перетаскивание меняет порядок и сохраняется.
- Баланс счёта меняется сразу после записи транзакции/перевода (realtime).

**Бюджеты**
- Месячный бюджет L=1000, rollover=ON:
  Август: потрачено 800 → carry +200;
  Сентябрь: потрачено 1300 → available −100 (carry −100 на октябрь).

**Отчёты**
- Общий баланс: «на сейчас» совпадает с суммой реальных остатков; «движение за период» корректно реагирует на чекбокс «исключить переводы».

**Импорт CSV**
- Мастер склейки корректно находит пары по эвристике; подтверждённые пары получают `transfer_id`; откат возвращает состояние.

---

## 13) Масштабирование (заложено заранее)
- Переход на UUID без смены API (скрываем тип в ORM).
- Категории: возможна миграция `path` → `ltree` без изменения внешних контрактов.
- При росте объёма — материализованные представления для отчётов и/или партиционирование `transactions` по дате/household.
- Realtime по необходимости можно перевести на собственный WS‑хаб (Postgres `LISTEN/NOTIFY`) без смены клиентских контрактов.

---

## 14) Roadmap
- **MVP** — всё из этого PRD.
- **v1.1** — расширенные отчёты (по участникам/по корням категорий), массовые операции, улучшенная автокатегоризация.
- **v1.2** — мультивалюта, расписания по долгам, напоминания.
- **Фиче‑флаг:** «Конверты» как отдельный тип счёта — добавляются без правок бюджетов.

